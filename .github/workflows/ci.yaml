name: build-test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python environment
        run: |
          sudo apt update -y
          sudo apt install -y python3-venv
          if [ ! -d "/home/shitshowinmypanties/venv" ]; then
            python3 -m venv /home/shitshowinmypanties/venv
          fi
          source /home/shitshowinmypanties/venv/bin/activate
          pip install --upgrade pip

      - name: Install dependencies
        run: |
          source /home/shitshowinmypanties/venv/bin/activate
          cd ${{ github.workspace }}
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "⚠️ No requirements.txt found."
          fi

      - name: Install and configure PM2
        run: |
          if ! command -v pm2 &> /dev/null; then
            sudo apt install -y nodejs npm
            sudo npm install -g pm2
          fi

      - name: Start FastAPI app with PM2 config
        run: |
          cd ${{ github.workspace }}
          pm2 delete mednexus || true
          pm2 start ecosystem.config.js
          pm2 save
          pm2 status

      - name: Verify app logs
        run: |
          pm2 logs mednexus --lines 20
